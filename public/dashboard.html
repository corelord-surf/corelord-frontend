<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CoreLord Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0d1117;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .profile {
      margin-top: 2rem;
      background-color: #161b22;
      padding: 1.5rem;
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
    }

    .profile p {
      margin: 0.5rem 0;
    }

    #signOutBtn {
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      background-color: #ffffff;
      color: #0d1117;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }

    #errorMessage {
      color: red;
      font-weight: bold;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>Welcome to Your Dashboard</h1>

  <p id="loadingMessage">Loading your profile...</p>

  <div id="profile" class="profile" style="display: none;">
    <p><strong>Name:</strong> <span id="name">Loading...</span></p>
    <p><strong>Email:</strong> <span id="email">Loading...</span></p>
    <p><strong>Phone:</strong> <span id="phone">Loading...</span></p>
    <p><strong>Country:</strong> <span id="country">Loading...</span></p>
    <button id="signOutBtn" onclick="signOut()">Sign Out</button>
  </div>

  <p id="errorMessage" style="display: none;">
    Session expired or access denied. Please <a href="index.html" style="color: #58a6ff;">sign in again</a>.
  </p>

  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <script>
    const msalConfig = {
      auth: {
        clientId: "7258cfca-e901-4077-8fba-224f8bc595e4",
        authority: "https://login.microsoftonline.com/d048d6e2-6e9f-4af0-afcf-58a5ad036480",
        redirectUri: "https://calm-coast-025fe8203.2.azurestaticapps.net/dashboard.html"
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: false
      }
    };

    const loginRequest = {
      scopes: ["openid", "profile", "email", "api://207b8fba-ea72-43e3-8c90-b3a39e58f5fc/user_impersonation"]
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    async function getProfile(token) {
      try {
        const response = await fetch("https://corelord-backend-etgpd9dfdufragfb.westeurope-01.azurewebsites.net/api/profile", {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error("API call failed");

        const data = await response.json();

        document.getElementById("name").textContent = data.FullName || "N/A";
        document.getElementById("email").textContent = msalInstance.getAllAccounts()[0]?.username || "N/A";
        document.getElementById("phone").textContent = data.PhoneNumber || "N/A";
        document.getElementById("country").textContent = data.Country || "N/A";

        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("profile").style.display = "block";
      } catch (err) {
        console.error("Profile fetch failed:", err);
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("errorMessage").style.display = "block";
      }
    }

    async function acquireTokenAndLoadProfile() {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length === 0) return redirectToLogin();

      try {
        const result = await msalInstance.acquireTokenSilent({
          ...loginRequest,
          account: accounts[0]
        });
        getProfile(result.accessToken);
      } catch (silentError) {
        console.warn("Silent token failed. Trying popup...", silentError);
        try {
          const result = await msalInstance.acquireTokenPopup(loginRequest);
          getProfile(result.accessToken);
        } catch (popupError) {
          console.error("Dashboard error:", popupError);
          document.getElementById("loadingMessage").style.display = "none";
          document.getElementById("errorMessage").style.display = "block";
        }
      }
    }

    function redirectToLogin() {
      window.location.href = "index.html";
    }

    function signOut() {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length > 0) {
        msalInstance.logout({ account: accounts[0] });
      }
    }

    window.addEventListener("DOMContentLoaded", acquireTokenAndLoadProfile);
  </script>
</body>
</html>
